(()=>{let e;function t(e){return(htmx.config.prefix||"hx-")+"ws"+e}function n(t,n){let r=e.attributeValue(t,"hx-ws:"+n);if(null!=r)return r;let s=e.attributeValue(t,"hx-ws-"+n);if(null!=s)return s;if("send"===n){let n=e.attributeValue(t,"hx-ws");if(null!=n)return n}return null}function r(e,t){let r=n(e,t);return null!=r}function s(e){let n=t(":"+e),r=t("-"+e);return`[${n.replace(":","\\:")}],[${r}]`}function o(){return{reconnect:!0,reconnectDelay:1e3,reconnectMaxDelay:3e4,reconnectJitter:!0,pendingRequestTTL:3e4,...htmx.config.websockets||{}}}function l(e){if(e.startsWith("ws://")||e.startsWith("wss://"))return e;if(e.startsWith("http://"))return"ws://"+e.slice(7);if(e.startsWith("https://"))return"wss://"+e.slice(8);let t="https:"===window.location.protocol?"wss:":"ws:",n=window.location.host;return e.startsWith("//")?t+e:e.startsWith("/")?t+"//"+n+e:t+"//"+n+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1)+e}const i=new Map;function a(e,t){let n=l(e);if(i.has(n)){let e=i.get(n);return e.refCount++,e.elements.add(t),e}let r={url:n,socket:null,refCount:1,elements:new Set([t]),reconnectAttempts:0,reconnectTimer:null,pendingRequests:new Map,listeners:{}};return x(t,"htmx:before:ws:connect",{url:n})?(i.set(n,r),c(n,r),r):null}function c(t,n){let r=n.elements.values().next().value;if(n.socket){let e=n.socket;n.socket=null,n.listeners.open&&e.removeEventListener("open",n.listeners.open),n.listeners.message&&e.removeEventListener("message",n.listeners.message),n.listeners.close&&e.removeEventListener("close",n.listeners.close),n.listeners.error&&e.removeEventListener("error",n.listeners.error);try{e.readyState!==WebSocket.OPEN&&e.readyState!==WebSocket.CONNECTING||e.close()}catch(e){}}try{n.socket=new WebSocket(t),n.listeners.open=()=>{n.reconnectAttempts=0,r&&x(r,"htmx:after:ws:connect",{url:t,socket:n.socket})},n.listeners.message=t=>{!function(t,n){let r;try{r=JSON.parse(n.data)}catch(e){let r=t.elements.values().next().value;return void(r&&x(r,"htmx:wsUnknownMessage",{data:n.data,parseError:e}))}r.channel=r.channel||"ui",r.format=r.format||"html";let s=null;r.request_id&&t.pendingRequests.has(r.request_id)?(s=t.pendingRequests.get(r.request_id).element,t.pendingRequests.delete(r.request_id)):s=t.elements.values().next().value;if(!x(s,"htmx:before:ws:message",{envelope:r,element:s}))return;"ui"===r.channel&&"html"===r.format?function(t,n){let r=(new DOMParser).parseFromString(n.payload||"","text/html"),s=r.querySelectorAll("hx-partial");if(0===s.length){let r=function(t,n){if(n)return"this"===n?t:document.querySelector(n);let r=e.attributeValue(t,"hx-target");if(r)return"this"===r?t:document.querySelector(r);return t}(t,n.target);return void(r&&d(r,n.payload,t,n.swap))}for(let e of s){let n=e.getAttribute("id");if(!n)continue;let r=document.getElementById(n);r&&d(r,e.innerHTML,t)}}(s,r):x(s,"htmx:wsMessage",{...r,element:s});x(s,"htmx:after:ws:message",{envelope:r,element:s})}(n,t)},n.listeners.close=e=>{if(e.target!==n.socket)return;if(r&&x(r,"htmx:ws:close",{url:t,code:e.code,reason:e.reason}),!i.has(t))return;o().reconnect&&n.refCount>0?function(e,t){let n=o();t.reconnectAttempts++;let r=t.reconnectAttempts,s=Math.min((n.reconnectDelay||1e3)*Math.pow(2,r-1),n.reconnectMaxDelay||3e4);n.reconnectJitter&&(s*=.75+.5*Math.random());t.reconnectTimer=setTimeout(()=>{if(t.refCount>0){let n=t.elements.values().next().value;n&&x(n,"htmx:ws:reconnect",{url:e,attempts:r}),c(e,t)}},s)}(t,n):(u(n),i.delete(t))},n.listeners.error=e=>{r&&x(r,"htmx:ws:error",{url:t,error:e})},n.socket.addEventListener("open",n.listeners.open),n.socket.addEventListener("message",n.listeners.message),n.socket.addEventListener("close",n.listeners.close),n.socket.addEventListener("error",n.listeners.error)}catch(e){r&&x(r,"htmx:ws:error",{url:t,error:e})}}function u(e){e.pendingRequests.clear()}function m(e){return!!e&&(e.startsWith("/")||e.startsWith(".")||e.startsWith("ws:")||e.startsWith("wss:")||e.startsWith("http:")||e.startsWith("https:")||e.startsWith("//"))}async function h(t,r){let a=n(t,"send");if(!m(a)){let e=s("connect"),r=t.closest(e);a=r?n(r,"connect"):null}if(!a)return void x(t,"htmx:wsSendError",{element:t,error:"No WebSocket connection found for element"});let c=l(a),u=i.get(c);if(!u||!u.socket||u.socket.readyState!==WebSocket.OPEN)return void x(t,"htmx:wsSendError",{url:c,error:"Connection not open"});!function(e){let t=o(),n=Date.now(),r=t.pendingRequestTTL||3e4;for(let[t,s]of e.pendingRequests)n-s.timestamp>r&&e.pendingRequests.delete(t)}(u);let h=t.form||t.closest("form"),d=e.collectFormData(t,h,r.submitter),f=e.handleHxVals(t,d);f&&await f;let w={};for(let[e,t]of d)e in w?(Array.isArray(w[e])||(w[e]=[w[e]]),w[e].push(t)):w[e]=t;let p={"HX-Request":"true","HX-Current-URL":window.location.href};t.id&&(p["HX-Trigger"]=t.id);let g=e.attributeValue(t,"hx-target");g&&(p["HX-Target"]=g);let b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),v={type:"request",request_id:b,event:r.type,headers:p,values:w,path:c};t.id&&(v.id=t.id);let y={data:v,element:t,url:c};if(x(t,"htmx:before:ws:send",y))try{u.socket.send(JSON.stringify(y.data)),u.pendingRequests.set(b,{element:t,timestamp:Date.now()}),x(t,"htmx:after:ws:send",{data:y.data,url:c})}catch(e){x(t,"htmx:wsSendError",{url:c,error:e})}}function d(t,n,r,s){let o=s||e.attributeValue(r,"hx-swap")||htmx.config.defaultSwap,l=document.createElement("template");l.innerHTML=n||"";let i={target:t,swapSpec:o,fragment:l.content};e.insertContent(i)}function x(e,t,n={}){return!e||htmx.trigger(e,t,n)}function f(e){e._htmx?.wsUrl&&function(e,t){let n=l(e);if(!i.has(n))return;let r=i.get(n);r.elements.delete(t),r.refCount--,r.refCount<=0&&(r.reconnectTimer&&clearTimeout(r.reconnectTimer),u(r),r.socket&&r.socket.readyState===WebSocket.OPEN&&r.socket.close(),i.delete(n))}(e._htmx.wsUrl,e),e._htmx?.wsSendHandler&&e.removeEventListener(e._htmx.wsSendEvent,e._htmx.wsSendHandler)}htmx.registerExtension("ws",{init:t=>{e=t,htmx.config.websockets||(htmx.config.websockets={})},htmx_after_process:o=>{const l=s=>{!function(e){if(e.hasAttribute("ws-connect")||e.hasAttribute("ws-send")){if(console.warn("HTMX WebSocket: Legacy attributes ws-connect and ws-send are deprecated. Please use hx-ws:connect/hx-ws-connect and hx-ws:send/hx-ws-send instead."),e.hasAttribute("ws-connect")){let n=e.getAttribute("ws-connect"),r=t("-connect");e.hasAttribute(r)||e.setAttribute(r,n)}if(e.hasAttribute("ws-send")){let n=t("-send");e.hasAttribute(n)||e.setAttribute(n,"")}}}(s),r(s,"connect")&&function(t){if(t._htmx?.wsInitialized)return;let r=n(t,"connect");if(!r)return;t._htmx=t._htmx||{},t._htmx.wsInitialized=!0;let s=e.attributeValue(t,"hx-trigger");if(s){let n=e.parseTriggerSpecs(s);if(n.length>0){let e=n[0];if("load"===e.name){let e=a(r,t);e&&(t._htmx.wsUrl=e.url)}else t.addEventListener(e.name,()=>{if(!t._htmx?.wsUrl){let e=a(r,t);e&&(t._htmx.wsUrl=e.url)}},{once:!0})}}else{let e=a(r,t);e&&(t._htmx.wsUrl=e.url)}}(s),r(s,"send")&&function(t){if(t._htmx?.wsSendInitialized)return;let r=n(t,"send"),s=m(r)?r:null,o=e.attributeValue(t,"hx-trigger");o||(o=t.matches("form")?"submit":t.matches("input:not([type=button]),select,textarea")?"change":"click");let l=e.parseTriggerSpecs(o);if(l.length>0){let e=l[0],n=async e=>{if(t.matches("form")&&"submit"===e.type&&e.preventDefault(),s&&!t._htmx?.wsUrl){let e=a(s,t);e&&(t._htmx.wsUrl=e.url)}await h(t,e)};t.addEventListener(e.name,n),t._htmx=t._htmx||{},t._htmx.wsSendInitialized=!0,t._htmx.wsSendHandler=n,t._htmx.wsSendEvent=e.name}}(s)};l(o);let i=`${s("connect")},${s("send")},[${t("")}],[ws-connect],[ws-send]`;o.querySelectorAll(i).forEach(l)},htmx_before_cleanup:e=>{f(e)}}),"undefined"!=typeof window&&window.htmx&&(window.htmx.ext=window.htmx.ext||{},window.htmx.ext.ws={getRegistry:()=>({clear:()=>{let e=Array.from(i.values());i.clear(),e.forEach(e=>{e.refCount=0,e.reconnectTimer&&clearTimeout(e.reconnectTimer),e.socket&&e.socket.close(),e.elements.clear(),e.pendingRequests.clear()})},get:e=>i.get(l(e)),has:e=>i.has(l(e)),size:i.size})})})();